# è©³ç´°è¨­è¨ˆæ›¸ - AIé§†å‹•å‹CADå›³é¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### 1.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ãƒ–ãƒ©ã‚¦ã‚¶ (Chrome/Edge/Firefox)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React + TypeScript)           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚ Upload View â”‚  â”‚ Search View â”‚  â”‚  List View  â”‚      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚        Drawing Editor View (2åˆ†å‰²)              â”‚      â”‚  â”‚
â”‚  â”‚  â”‚  Left: Form (30%)  |  Right: PDF Viewer (70%)  â”‚      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  State Management: Zustand/Jotai                          â”‚  â”‚
â”‚  â”‚  PDF Rendering: PDF.js                                     â”‚  â”‚
â”‚  â”‚  UI Components: shadcn/ui (Blue/White theme)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP/WebSocket
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Python + FastAPI)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    REST API Layer                          â”‚  â”‚
â”‚  â”‚  /api/upload  /api/drawings  /api/search  /api/locks      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Service Layer                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ Drawing      â”‚  â”‚  AI Analysis â”‚  â”‚  Search      â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ Service      â”‚  â”‚  Service     â”‚  â”‚  Service     â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ Lock         â”‚  â”‚  Config      â”‚  â”‚  File        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ Manager      â”‚  â”‚  Manager     â”‚  â”‚  Manager     â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    AI Integration Layer                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚         Claude API Client (boto3/anthropic)        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - å›³æ æŠ½å‡º  - é¢¨èˆ¹æŠ½å‡º  - åˆ†é¡  - é¡ä¼¼æ¤œç´¢       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Retry Logic (exponential backoff)              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Confidence Score Extraction                    â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Data Access Layer                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚         SQLite Database (SQLAlchemy ORM)         â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - drawings  - balloons  - tags  - revisions     â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - edit_history  - locks                         â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ./storage/                                               â”‚  â”‚
â”‚  â”‚    â”œâ”€â”€ drawings/          # PDFåŸæœ¬ãƒ•ã‚¡ã‚¤ãƒ«               â”‚  â”‚
â”‚  â”‚    â”œâ”€â”€ thumbnails/        # ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ                â”‚  â”‚
â”‚  â”‚    â”œâ”€â”€ database.db        # SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹            â”‚  â”‚
â”‚  â”‚    â””â”€â”€ config.json        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘
                           â”‚ AWS Bedrock API
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AWS Claude Sonnet 4                          â”‚
â”‚                  (us.anthropic.claude-sonnet-4.0)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **è¨€èª**: TypeScript 5.x
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: React 18.x
- **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: Vite 5.x
- **çŠ¶æ…‹ç®¡ç†**: Zustand 4.x
- **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: React Router 6.x
- **UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
  - shadcn/ui (ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªé’/ç™½ãƒ†ãƒ¼ãƒ)
  - Tailwind CSS 3.x
- **PDFè¡¨ç¤º**:
  - PDF.js (Mozilla)
  - react-pdf-viewer
- **é€šçŸ¥**: react-hot-toast
- **ãƒ•ã‚©ãƒ¼ãƒ **: React Hook Form + Zod
- **HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: Axios
- **WebSocket**: Socket.IO Client

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Python)
- **è¨€èª**: Python 3.11+
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: FastAPI 0.104+
- **ASGI ã‚µãƒ¼ãƒãƒ¼**: Uvicorn
- **ORM**: SQLAlchemy 2.x
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLite 3
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: Pydantic 2.x
- **AWS SDK**: boto3 (Bedrock Runtimeç”¨)
- **Claude SDK**: anthropic (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- **PDFå‡¦ç†**:
  - PyMuPDF (fitz) - PDF to Image
  - Pillow - ç”»åƒå‡¦ç†
- **WebSocket**: python-socketio
- **ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼**: Celery + Redis (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ç”¨)
- **è¨­å®šç®¡ç†**: python-dotenv, pydantic-settings
- **ãƒ†ã‚¹ãƒˆ**: pytest, pytest-asyncio

#### é–‹ç™ºãƒ„ãƒ¼ãƒ«
- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£**:
  - npm/yarn (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)
  - Poetry (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰)
- **ãƒªãƒ³ã‚¿ãƒ¼/ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼**:
  - ESLint + Prettier (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)
  - Black + Ruff (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰)
- **å‹ãƒã‚§ãƒƒã‚¯**: mypy (Python)
- **API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: OpenAPI (FastAPI è‡ªå‹•ç”Ÿæˆ)

## 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 2.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€è¦§

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå | è²¬å‹™ | ä¾å­˜é–¢ä¿‚ |
|-----------------|------|---------|
| **API Router** | HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | Service Layer |
| **Drawing Service** | å›³é¢ã®CRUDæ“ä½œ | DAL, File Manager, AI Service |
| **AI Analysis Service** | Claude APIã‚’ä½¿ã£ãŸå›³é¢è§£æ | Claude Client, Config Manager |
| **Search Service** | è‡ªç„¶è¨€èªæ¤œç´¢ã€é¡ä¼¼æ¤œç´¢ | DAL, AI Service |
| **Lock Manager** | ç·¨é›†ãƒ­ãƒƒã‚¯ç®¡ç† | DAL, WebSocket Manager |
| **File Manager** | ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ãƒ»å‰Šé™¤ãƒ»ãƒªãƒãƒ¼ãƒ  | OS File System |
| **Config Manager** | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ | File System |
| **WebSocket Manager** | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ | Lock Manager |
| **Claude API Client** | AWS Bedrock Claude APIå‘¼ã³å‡ºã— | boto3 |
| **Data Access Layer (DAL)** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ | SQLAlchemy |

### 2.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€è¦§

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå | è²¬å‹™ | ä¾å­˜é–¢ä¿‚ |
|-----------------|------|---------|
| **App** | ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | All Views |
| **UploadView** | å›³é¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ | FileUploader, API Client |
| **DrawingEditorView** | å›³é¢ç·¨é›†ç”»é¢(2åˆ†å‰²) | EditForm, PDFViewer |
| **SearchView** | æ¤œç´¢ç”»é¢(è‡ªç„¶è¨€èª/é¡ä¼¼) | SearchForm, ResultList |
| **ListView** | å›³é¢ä¸€è¦§ç”»é¢ | DrawingTable, DrawingCard |
| **EditForm** | è§£æçµæœç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  | FormField, TagInput |
| **PDFViewer** | PDFè¡¨ç¤ºã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ | PDF.js, Canvas |
| **DrawingTable** | ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã®å›³é¢ä¸€è¦§ | Table, Checkbox |
| **DrawingCard** | ã‚«ãƒ¼ãƒ‰å½¢å¼ã®å›³é¢ä¸€è¦§ | Card, Thumbnail |
| **Toast Notification** | ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ | react-hot-toast |
| **Modal Dialog** | ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° | shadcn/ui Dialog |
| **API Client** | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå‘¼ã³å‡ºã— | Axios |

### 2.3 å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°

#### 2.3.1 AI Analysis Service (Python)

**ç›®çš„**: Claude Sonnet 4ã‚’ä½¿ã£ãŸå›³é¢è§£æã®å®Ÿè¡Œ

**å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
from typing import Dict, List, Optional
from pydantic import BaseModel

class ConfidenceScore(BaseModel):
    field_name: str
    value: any
    confidence: float  # 0-100

class BalloonInfo(BaseModel):
    balloon_number: str
    part_name: str
    quantity: int
    x: float
    y: float
    confidence: float

class RevisionHistory(BaseModel):
    revision_number: str
    revision_date: str
    revision_content: str
    reviser: str
    confidence: float

class AnalysisResult(BaseModel):
    drawing_id: str
    classification: str  # "éƒ¨å“å›³" | "ãƒ¦ãƒ‹ãƒƒãƒˆå›³" | "çµ„å›³"
    classification_confidence: float
    classification_reason: str
    extracted_fields: List[ConfidenceScore]
    balloons: List[BalloonInfo]
    revisions: List[RevisionHistory]
    summary: str  # å›³é¢ã®è¦ç´„
    shape_features: Optional[Dict[str, any]]  # ãƒ—ãƒ¬ãƒ¼ãƒˆå›³ã®ç‰¹å¾´

class AIAnalysisService:
    def __init__(self, config_manager: ConfigManager):
        self.config = config_manager
        self.client = self._init_claude_client()

    async def analyze_drawing(
        self,
        image_data: bytes,
        extraction_fields: List[str]
    ) -> AnalysisResult:
        """
        å›³é¢ã‚’è§£æã—ã€å›³æ æƒ…å ±ãƒ»é¢¨èˆ¹ãƒ»åˆ†é¡ã‚’æŠ½å‡º

        Args:
            image_data: PDF ã‹ã‚‰å¤‰æ›ã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ (PNG/JPEG)
            extraction_fields: æŠ½å‡ºã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®ãƒªã‚¹ãƒˆ

        Returns:
            AnalysisResult: è§£æçµæœ

        Raises:
            AIAnalysisException: APIå‘¼ã³å‡ºã—å¤±æ•—æ™‚
        """
        pass

    async def classify_drawing(
        self,
        image_data: bytes
    ) -> tuple[str, float, str]:
        """
        å›³é¢ã‚’éƒ¨å“å›³/ãƒ¦ãƒ‹ãƒƒãƒˆå›³/çµ„å›³ã«åˆ†é¡

        Returns:
            (åˆ†é¡, ä¿¡é ¼åº¦, ç†ç”±)
        """
        pass

    async def extract_balloons(
        self,
        image_data: bytes
    ) -> List[BalloonInfo]:
        """
        é¢¨èˆ¹æƒ…å ±ã‚’æŠ½å‡º
        """
        pass

    async def search_similar_drawings(
        self,
        query_drawing_id: str,
        all_drawings: List[Dict]
    ) -> List[tuple[str, float]]:
        """
        é¡ä¼¼å›³é¢ã‚’æ¤œç´¢

        Returns:
            [(drawing_id, similarity_score), ...]
        """
        pass

    async def parse_natural_language_query(
        self,
        query: str
    ) -> Dict[str, any]:
        """
        è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒªã‚’æ§‹é€ åŒ–ã‚¯ã‚¨ãƒªã«å¤‰æ›

        Args:
            query: "ä½œæˆè€…ãŒç”°ä¸­ã®å›³é¢ã‚’å…¨éƒ¨ã»ã—ã„"

        Returns:
            {"field": "creator", "operator": "equals", "value": "ç”°ä¸­"}
        """
        pass
```

**å†…éƒ¨å®Ÿè£…æ–¹é‡**:
- **ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯**: `tenacity` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(`prompts/`)ã«åˆ†é›¢ã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
- **ä¿¡é ¼åº¦æŠ½å‡º**: Claude ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆJSON modeä½¿ç”¨ï¼‰
- **ç”»åƒå‰å‡¦ç†**: è§£åƒåº¦èª¿æ•´ï¼ˆæœ€å¤§4096pxï¼‰ã€PNGå¤‰æ›
- **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ï¼ˆåŒä¸€ç”»åƒã®å†è§£æã‚’é˜²ãï¼‰

#### 2.3.2 Drawing Service (Python)

**ç›®çš„**: å›³é¢ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

**å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
class DrawingService:
    def __init__(
        self,
        db: Database,
        file_manager: FileManager,
        ai_service: AIAnalysisService
    ):
        pass

    async def create_drawing(
        self,
        pdf_file: UploadFile,
        user_id: str
    ) -> Drawing:
        """
        æ–°è¦å›³é¢ã‚’ç™»éŒ²ã—ã€AIè§£æã‚’é–‹å§‹
        """
        pass

    async def update_drawing(
        self,
        drawing_id: str,
        updates: Dict[str, any],
        user_id: str
    ) -> Drawing:
        """
        å›³é¢ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã€ç·¨é›†å±¥æ­´ã‚’è¨˜éŒ²
        """
        pass

    async def approve_drawing(
        self,
        drawing_id: str,
        user_id: str
    ) -> Drawing:
        """
        å›³é¢ã‚’æ‰¿èªçŠ¶æ…‹ã«ã™ã‚‹
        """
        pass

    async def unapprove_drawing(
        self,
        drawing_id: str,
        user_id: str
    ) -> Drawing:
        """
        å›³é¢ã‚’æœªæ‰¿èªçŠ¶æ…‹ã«æˆ»ã™
        """
        pass

    async def delete_drawings(
        self,
        drawing_ids: List[str],
        user_id: str
    ) -> int:
        """
        å›³é¢ã‚’å‰Šé™¤ï¼ˆç‰©ç†å‰Šé™¤ï¼‰
        """
        pass

    async def bulk_update_tags(
        self,
        drawing_ids: List[str],
        tags: List[str],
        user_id: str
    ) -> int:
        """
        è¤‡æ•°å›³é¢ã«ä¸€æ‹¬ã‚¿ã‚°ä»˜ã‘
        """
        pass
```

#### 2.3.3 Lock Manager (Python)

**ç›®çš„**: è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã®ç·¨é›†ãƒ­ãƒƒã‚¯ç®¡ç†

**å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```python
class LockManager:
    def __init__(self, db: Database, websocket_manager: WebSocketManager):
        self.locks: Dict[str, Lock] = {}  # drawing_id -> Lock
        self.timeout_seconds = 300  # 5åˆ†

    async def acquire_lock(
        self,
        drawing_id: str,
        user_id: str
    ) -> bool:
        """
        ãƒ­ãƒƒã‚¯ã‚’å–å¾—

        Returns:
            True: ãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸ
            False: æ—¢ã«ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ãƒƒã‚¯ä¸­
        """
        pass

    async def release_lock(
        self,
        drawing_id: str,
        user_id: str
    ) -> None:
        """
        ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾
        """
        pass

    async def check_lock(
        self,
        drawing_id: str
    ) -> Optional[Lock]:
        """
        ç¾åœ¨ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèª
        """
        pass

    async def cleanup_expired_locks(self) -> None:
        """
        ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸãƒ­ãƒƒã‚¯ã‚’è‡ªå‹•è§£æ”¾
        ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã§å®šæœŸå®Ÿè¡Œï¼‰
        """
        pass
```

#### 2.3.4 PDFViewer Component (React)

**ç›®çš„**: PDFè¡¨ç¤ºã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆ

**å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```typescript
interface Highlight {
  x: number;
  y: number;
  width: number;
  height: number;
  color?: string;
}

interface PDFViewerProps {
  pdfUrl: string;
  highlights?: Highlight[];
  onHighlightClick?: (highlight: Highlight) => void;
  initialScale?: number;
}

const PDFViewer: React.FC<PDFViewerProps> = ({
  pdfUrl,
  highlights = [],
  onHighlightClick,
  initialScale = 1.0
}) => {
  const [scale, setScale] = useState(initialScale);
  const [rotation, setRotation] = useState(0);
  const [pageNumber, setPageNumber] = useState(1);
  const [numPages, setNumPages] = useState(0);

  const zoomIn = () => setScale(s => Math.min(s + 0.2, 3.0));
  const zoomOut = () => setScale(s => Math.max(s - 0.2, 0.5));
  const rotate = () => setRotation(r => (r + 90) % 360);

  const drawHighlights = (canvas: HTMLCanvasElement) => {
    // Canvas API ã‚’ä½¿ã£ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æç”»
  };

  return (
    <div className="pdf-viewer">
      <div className="controls">
        <button onClick={zoomIn}>+</button>
        <button onClick={zoomOut}>-</button>
        <button onClick={rotate}>âŸ³</button>
        <span>{pageNumber} / {numPages}</span>
      </div>
      <Document file={pdfUrl} onLoadSuccess={onDocumentLoadSuccess}>
        <Page
          pageNumber={pageNumber}
          scale={scale}
          rotate={rotation}
          onRenderSuccess={() => drawHighlights(canvasRef.current)}
        />
      </Document>
    </div>
  );
};
```

**å†…éƒ¨å®Ÿè£…æ–¹é‡**:
- PDF.js ã® Worker ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- Canvas ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ã£ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æç”»
- ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã«åº§æ¨™ã‚’æ¤œå‡ºã—ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ

#### 2.3.5 EditForm Component (React)

**ç›®çš„**: è§£æçµæœã®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 

```typescript
interface EditFormProps {
  drawing: Drawing;
  onSave: (updates: Partial<Drawing>) => Promise<void>;
  onFieldClick: (fieldName: string, coordinates: Coordinates) => void;
}

const EditForm: React.FC<EditFormProps> = ({ drawing, onSave, onFieldClick }) => {
  const { register, handleSubmit, watch } = useForm();

  const renderFieldWithConfidence = (
    fieldName: string,
    value: any,
    confidence: number
  ) => {
    const showWarning = confidence < 70;

    return (
      <div className="field-group">
        <label onClick={() => onFieldClick(fieldName, drawing.coordinates[fieldName])}>
          {fieldName}
          <span className="confidence">({confidence}%)</span>
        </label>
        <input
          {...register(fieldName)}
          defaultValue={value}
          className={showWarning ? 'warning' : ''}
        />
        {showWarning && (
          <div className="inline-warning">
            ä¿¡é ¼åº¦ãŒä½ã„ãŸã‚ã€å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
          </div>
        )}
      </div>
    );
  };

  return (
    <form onSubmit={handleSubmit(onSave)} className="edit-form">
      <section>
        <h3>ğŸ“„ åŸºæœ¬æƒ…å ±</h3>
        {drawing.extractedFields.map(field =>
          renderFieldWithConfidence(field.name, field.value, field.confidence)
        )}
      </section>

      <section>
        <h3>ğŸ·ï¸ ã‚¿ã‚°ãƒ»åˆ†é¡</h3>
        <TagInput tags={drawing.tags} onChange={...} />
        <CategorySelect value={drawing.category} onChange={...} />
      </section>

      <section>
        <h3>ğŸ“ æ”¹è¨‚å±¥æ­´</h3>
        <RevisionTable revisions={drawing.revisions} />
      </section>

      <section>
        <h3>ğŸˆ é¢¨èˆ¹æƒ…å ±</h3>
        <BalloonTable
          balloons={drawing.balloons}
          onBalloonClick={(balloon) => onFieldClick('balloon', balloon.coordinates)}
        />
      </section>

      <section>
        <h3>ğŸ“œ ç·¨é›†å±¥æ­´</h3>
        <EditHistoryPanel history={drawing.editHistory} />
      </section>

      <div className="form-actions">
        <button type="submit">ä¿å­˜</button>
        <button type="button" onClick={onApprove}>æ‰¿èª</button>
      </div>
    </form>
  );
};
```

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 3.1 å›³é¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰æ‰¿èªã¾ã§ã®ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ (1) PDF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
[Frontend: UploadView]
    â†“ (2) POST /api/drawings/upload (multipart/form-data)
[Backend: DrawingRouter]
    â†“ (3) DrawingService.create_drawing()
[DrawingService]
    â”œâ”€ (4) FileManager.save_pdf()
    â”‚   â””â†’ ./storage/drawings/{uuid}.pdf
    â”œâ”€ (5) PDF to Image å¤‰æ›
    â””â”€ (6) AIAnalysisService.analyze_drawing()
        â†“ (7) AWS Bedrock Claude API å‘¼ã³å‡ºã—
[Claude Sonnet 4]
        â†“ (8) è§£æçµæœ (JSON with confidence)
[AIAnalysisService]
    â†“ (9) ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‘ãƒ¼ã‚¹
[DrawingService]
    â†“ (10) DBä¿å­˜ (SQLite)
[Database]
    â†“ (11) è§£æçµæœã‚’è¿”ã™
[Frontend: DrawingEditorView]
    â†“ (12) 2åˆ†å‰²ç”»é¢ã§è¡¨ç¤º
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ (13) ç·¨é›†ãƒ»ç¢ºèª
[EditForm]
    â†“ (14) æ‰¿èªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
[Frontend]
    â†“ (15) PUT /api/drawings/{id}/approve
[DrawingService]
    â†“ (16) drawing.status = "approved"
[Database]
    â†“ (17) æ‰¿èªå®Œäº†é€šçŸ¥
[Frontend: Toast]
```

### 3.2 ç·¨é›†ãƒ­ãƒƒã‚¯ã®ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼A]
    â†“ (1) å›³é¢ç·¨é›†ç”»é¢ã‚’é–‹ã
[Frontend]
    â†“ (2) POST /api/locks/acquire
[LockManager]
    â”œâ”€ (3) ãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸ
    â””â”€ (4) WebSocket ã§ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
        â†“
[ãƒ¦ãƒ¼ã‚¶ãƒ¼B (åˆ¥PC)]
    â†“ (5) åŒã˜å›³é¢ã‚’é–‹ã“ã†ã¨ã™ã‚‹
[Frontend]
    â†“ (6) POST /api/locks/acquire
[LockManager]
    â”œâ”€ (7) ãƒ­ãƒƒã‚¯å¤±æ•— (ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒãƒ­ãƒƒã‚¯ä¸­)
    â””â”€ (8) Toasté€šçŸ¥ "ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒç·¨é›†ä¸­ã§ã™"
[Frontend]
    â””â”€ (9) èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤º
```

### 3.3 è‡ªç„¶è¨€èªæ¤œç´¢ã®ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ (1) "ä½œæˆè€…ãŒç”°ä¸­ã®å›³é¢ã‚’å…¨éƒ¨ã»ã—ã„" ã¨å…¥åŠ›
[Frontend: SearchView]
    â†“ (2) POST /api/search/natural
[SearchService]
    â†“ (3) AIAnalysisService.parse_natural_language_query()
[Claude API]
    â†“ (4) {"field": "creator", "operator": "equals", "value": "ç”°ä¸­"}
[SearchService]
    â†“ (5) SQLã‚¯ã‚¨ãƒªã«å¤‰æ›ã—ã¦å®Ÿè¡Œ
    â””â”€ SELECT * FROM drawings WHERE creator = 'ç”°ä¸­'
[Database]
    â†“ (6) æ¤œç´¢çµæœã‚’è¿”ã™
[Frontend: ResultList]
    â†“ (7) ãƒ†ãƒ¼ãƒ–ãƒ«/ã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤º
```

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 4.1 ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

#### drawings ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE drawings (
    id TEXT PRIMARY KEY,  -- UUID
    pdf_filename TEXT NOT NULL,
    pdf_path TEXT NOT NULL,
    thumbnail_path TEXT,
    status TEXT NOT NULL,  -- 'pending', 'analyzing', 'approved', 'unapproved'
    classification TEXT,  -- 'éƒ¨å“å›³', 'ãƒ¦ãƒ‹ãƒƒãƒˆå›³', 'çµ„å›³'
    classification_confidence REAL,
    classification_reason TEXT,
    summary TEXT,  -- å›³é¢ã®è¦ç´„
    shape_features JSON,  -- ãƒ—ãƒ¬ãƒ¼ãƒˆå›³ã®ç‰¹å¾´
    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    approved_date TIMESTAMP,
    created_by TEXT NOT NULL,  -- PCãƒ›ã‚¹ãƒˆå/ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### extracted_fields ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE extracted_fields (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    drawing_id TEXT NOT NULL,
    field_name TEXT NOT NULL,
    field_value TEXT,
    confidence REAL,  -- 0-100
    coordinates JSON,  -- {"x": 100, "y": 200, "width": 50, "height": 20}
    FOREIGN KEY (drawing_id) REFERENCES drawings(id) ON DELETE CASCADE
);

CREATE INDEX idx_extracted_fields_drawing ON extracted_fields(drawing_id);
```

#### balloons ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE balloons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    drawing_id TEXT NOT NULL,
    balloon_number TEXT,
    part_name TEXT,
    quantity INTEGER,
    x REAL,
    y REAL,
    confidence REAL,
    FOREIGN KEY (drawing_id) REFERENCES drawings(id) ON DELETE CASCADE
);

CREATE INDEX idx_balloons_drawing ON balloons(drawing_id);
```

#### revisions ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE revisions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    drawing_id TEXT NOT NULL,
    revision_number TEXT,
    revision_date TEXT,
    revision_content TEXT,
    reviser TEXT,
    confidence REAL,
    FOREIGN KEY (drawing_id) REFERENCES drawings(id) ON DELETE CASCADE
);

CREATE INDEX idx_revisions_drawing ON revisions(drawing_id);
```

#### tags ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    drawing_id TEXT NOT NULL,
    tag_name TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (drawing_id) REFERENCES drawings(id) ON DELETE CASCADE
);

CREATE INDEX idx_tags_drawing ON tags(drawing_id);
CREATE INDEX idx_tags_name ON tags(tag_name);
```

#### edit_history ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE edit_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    drawing_id TEXT NOT NULL,
    user_id TEXT NOT NULL,  -- PCãƒ›ã‚¹ãƒˆå/ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    field_name TEXT NOT NULL,
    old_value TEXT,
    new_value TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (drawing_id) REFERENCES drawings(id) ON DELETE CASCADE
);

CREATE INDEX idx_edit_history_drawing ON edit_history(drawing_id);
```

#### locks ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE locks (
    drawing_id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    acquired_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    FOREIGN KEY (drawing_id) REFERENCES drawings(id) ON DELETE CASCADE
);
```

### 4.2 SQLAlchemy ãƒ¢ãƒ‡ãƒ«å®šç¾©

```python
from sqlalchemy import Column, String, Text, Integer, Float, JSON, TIMESTAMP, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
import uuid

class Drawing(Base):
    __tablename__ = 'drawings'

    id = Column(String, primary_key=True, default=lambda: str(uuid.uuid4()))
    pdf_filename = Column(String, nullable=False)
    pdf_path = Column(String, nullable=False)
    thumbnail_path = Column(String)
    status = Column(String, nullable=False, default='pending')
    classification = Column(String)
    classification_confidence = Column(Float)
    classification_reason = Column(Text)
    summary = Column(Text)
    shape_features = Column(JSON)
    upload_date = Column(TIMESTAMP, default=datetime.utcnow)
    approved_date = Column(TIMESTAMP)
    created_by = Column(String, nullable=False)
    updated_at = Column(TIMESTAMP, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    extracted_fields = relationship('ExtractedField', back_populates='drawing', cascade='all, delete-orphan')
    balloons = relationship('Balloon', back_populates='drawing', cascade='all, delete-orphan')
    revisions = relationship('Revision', back_populates='drawing', cascade='all, delete-orphan')
    tags = relationship('Tag', back_populates='drawing', cascade='all, delete-orphan')
    edit_history = relationship('EditHistory', back_populates='drawing', cascade='all, delete-orphan')
    lock = relationship('Lock', back_populates='drawing', uselist=False, cascade='all, delete-orphan')

class ExtractedField(Base):
    __tablename__ = 'extracted_fields'

    id = Column(Integer, primary_key=True)
    drawing_id = Column(String, ForeignKey('drawings.id'), nullable=False)
    field_name = Column(String, nullable=False)
    field_value = Column(Text)
    confidence = Column(Float)
    coordinates = Column(JSON)

    drawing = relationship('Drawing', back_populates='extracted_fields')
```

## 5. APIè¨­è¨ˆ

### 5.1 REST API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### å›³é¢ç®¡ç†

```
POST /api/drawings/upload
Content-Type: multipart/form-data
Body: {file: File, user_id: string}
Response: {drawing_id: string, status: string}

GET /api/drawings
Query: ?status=approved&classification=éƒ¨å“å›³&page=1&limit=20
Response: {drawings: Drawing[], total: number}

GET /api/drawings/{drawing_id}
Response: Drawing

PUT /api/drawings/{drawing_id}
Body: {extracted_fields: {...}, tags: [...], classification: string}
Response: Drawing

PUT /api/drawings/{drawing_id}/approve
Body: {user_id: string}
Response: {status: 'approved'}

PUT /api/drawings/{drawing_id}/unapprove
Body: {user_id: string}
Response: {status: 'unapproved'}

DELETE /api/drawings
Body: {drawing_ids: string[], user_id: string}
Response: {deleted_count: number}

POST /api/drawings/bulk/tags
Body: {drawing_ids: string[], tags: string[], user_id: string}
Response: {updated_count: number}

POST /api/drawings/bulk/category
Body: {drawing_ids: string[], category: string, user_id: string}
Response: {updated_count: number}

GET /api/drawings/{drawing_id}/download
Response: File (PDF)

POST /api/drawings/download/bulk
Body: {drawing_ids: string[]}
Response: File (ZIP)

POST /api/drawings/{drawing_id}/reanalyze
Body: {user_id: string}
Response: {job_id: string}
```

#### æ¤œç´¢

```
POST /api/search/natural
Body: {query: string}
Response: {drawings: Drawing[], total: number}

POST /api/search/similar
Body: {drawing_id: string}
Response: {similar_drawings: Array<{drawing: Drawing, similarity: number}>}
```

#### ãƒ­ãƒƒã‚¯ç®¡ç†

```
POST /api/locks/acquire
Body: {drawing_id: string, user_id: string}
Response: {success: boolean, current_lock?: {user_id: string, expires_at: timestamp}}

DELETE /api/locks/release
Body: {drawing_id: string, user_id: string}
Response: {success: boolean}

GET /api/locks/{drawing_id}
Response: {locked: boolean, user_id?: string, expires_at?: timestamp}
```

#### è¨­å®š

```
GET /api/config/extraction-fields
Response: {fields: Array<{name: string, required: boolean}>}
```

### 5.2 WebSocket ã‚¤ãƒ™ãƒ³ãƒˆ

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼
socket.emit('subscribe_drawing', {drawing_id: string});
socket.emit('unsubscribe_drawing', {drawing_id: string});

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
socket.on('drawing_locked', {drawing_id: string, user_id: string});
socket.on('drawing_unlocked', {drawing_id: string});
socket.on('drawing_updated', {drawing_id: string});
```

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 6.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡

| ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ— | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å¯¾å‡¦æ–¹æ³• |
|-------------|---------------|---------|
| **ValidationError** | 400 | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º |
| **NotFoundError** | 404 | ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€‚é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º |
| **LockError** | 409 | ç·¨é›†ãƒ­ãƒƒã‚¯ç«¶åˆã€‚ãƒ­ãƒƒã‚¯ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é€šçŸ¥ |
| **AIAnalysisError** | 500 | Claude API ã‚¨ãƒ©ãƒ¼ã€‚ãƒªãƒˆãƒ©ã‚¤ã¾ãŸã¯ã€Œå†è§£æã€ãƒœã‚¿ãƒ³è¡¨ç¤º |
| **FileStorageError** | 500 | ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼ã€‚ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª |
| **DatabaseError** | 500 | DBæ“ä½œã‚¨ãƒ©ãƒ¼ã€‚ãƒ­ã‚°ã«è¨˜éŒ²ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯æ±ç”¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º |

### 6.2 Python ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¾‹

```python
from fastapi import HTTPException
from tenacity import retry, stop_after_attempt, wait_exponential

class AIAnalysisException(Exception):
    pass

class LockException(Exception):
    pass

# ãƒªãƒˆãƒ©ã‚¤ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=2, min=2, max=10),
    reraise=True
)
async def call_claude_api(prompt: str, image_data: bytes):
    try:
        response = await client.messages.create(...)
        return response
    except Exception as e:
        logger.error(f"Claude API error: {e}")
        raise AIAnalysisException(f"AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}")

# FastAPI ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
@app.exception_handler(AIAnalysisException)
async def ai_analysis_exception_handler(request: Request, exc: AIAnalysisException):
    return JSONResponse(
        status_code=500,
        content={
            "error": "ai_analysis_error",
            "message": str(exc),
            "retryable": True
        }
    )

@app.exception_handler(LockException)
async def lock_exception_handler(request: Request, exc: LockException):
    return JSONResponse(
        status_code=409,
        content={
            "error": "lock_conflict",
            "message": str(exc)
        }
    )
```

### 6.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// API Client ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
const apiClient = axios.create({
  baseURL: '/api',
  timeout: 30000,
});

apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    const { response } = error;

    if (response?.status === 409) {
      // ãƒ­ãƒƒã‚¯ç«¶åˆ
      toast.error(`ç·¨é›†ä¸­: ${response.data.message}`);
    } else if (response?.status === 500 && response.data.retryable) {
      // ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã‚¨ãƒ©ãƒ¼
      toast.error('è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã€Œå†è§£æã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    } else {
      // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
      toast.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
    }

    return Promise.reject(error);
  }
);
```

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 7.1 AWSèªè¨¼æƒ…å ±ã®ä¿è­·

```python
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
AWS_REGION=us-west-2
AWS_ACCESS_KEY_ID=xxxxx
AWS_SECRET_ACCESS_KEY=xxxxx

# ã¾ãŸã¯ AWSèªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«
# ~/.aws/credentials

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®èª­ã¿è¾¼ã¿
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    aws_region: str
    aws_access_key_id: str
    aws_secret_access_key: str

    class Config:
        env_file = '.env'
        env_file_encoding = 'utf-8'

settings = Settings()

# boto3 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
import boto3

bedrock_client = boto3.client(
    'bedrock-runtime',
    region_name=settings.aws_region,
    aws_access_key_id=settings.aws_access_key_id,
    aws_secret_access_key=settings.aws_secret_access_key
)
```

### 7.2 å…¥åŠ›æ¤œè¨¼

```python
from pydantic import BaseModel, Field, validator
from typing import List, Optional

class DrawingUpdateRequest(BaseModel):
    extracted_fields: Optional[Dict[str, str]]
    tags: Optional[List[str]] = Field(max_items=50)
    classification: Optional[str]

    @validator('tags')
    def validate_tags(cls, v):
        if v:
            for tag in v:
                if len(tag) > 100:
                    raise ValueError('ã‚¿ã‚°ã¯100æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„')
                if not tag.strip():
                    raise ValueError('ç©ºã®ã‚¿ã‚°ã¯ç™»éŒ²ã§ãã¾ã›ã‚“')
        return v

    @validator('classification')
    def validate_classification(cls, v):
        if v and v not in ['éƒ¨å“å›³', 'ãƒ¦ãƒ‹ãƒƒãƒˆå›³', 'çµ„å›³']:
            raise ValueError('ç„¡åŠ¹ãªåˆ†é¡ã§ã™')
        return v

# PDFãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
async def validate_pdf_file(file: UploadFile):
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    file.file.seek(0, 2)
    file_size = file.file.tell()
    file.file.seek(0)

    if file_size > 50 * 1024 * 1024:  # 50MB
        raise HTTPException(400, "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯50MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„")

    # MIME type ãƒã‚§ãƒƒã‚¯
    if file.content_type != 'application/pdf':
        raise HTTPException(400, "PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™")

    # PDFå½¢å¼ã®æ¤œè¨¼ (PyMuPDF)
    try:
        doc = fitz.open(stream=await file.read(), filetype="pdf")
        doc.close()
    except Exception:
        raise HTTPException(400, "ç„¡åŠ¹ãªPDFãƒ•ã‚¡ã‚¤ãƒ«ã§ã™")
```

### 7.3 XSSå¯¾ç­–

```typescript
// ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
import DOMPurify from 'dompurify';

const SafeHTML: React.FC<{html: string}> = ({html}) => {
  const sanitized = DOMPurify.sanitize(html);
  return <div dangerouslySetInnerHTML={{__html: sanitized}} />;
};
```

## 8. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 8.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

**ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: 70%ä»¥ä¸Š

**Python (pytest)**:
```python
# tests/test_ai_service.py
import pytest
from unittest.mock import AsyncMock, patch

@pytest.mark.asyncio
async def test_analyze_drawing_success():
    # Arrange
    mock_client = AsyncMock()
    mock_client.messages.create.return_value = {
        "content": [{
            "text": '{"å›³ç•ª": "ABC-001", "confidence": 95}'
        }]
    }

    service = AIAnalysisService(config)
    service.client = mock_client

    # Act
    result = await service.analyze_drawing(image_data, ["å›³ç•ª"])

    # Assert
    assert result.extracted_fields[0].field_name == "å›³ç•ª"
    assert result.extracted_fields[0].confidence == 95

@pytest.mark.asyncio
async def test_analyze_drawing_retry_on_failure():
    # Claude API ãŒ2å›å¤±æ•—å¾Œã€3å›ç›®ã§æˆåŠŸ
    mock_client = AsyncMock()
    mock_client.messages.create.side_effect = [
        Exception("API Error"),
        Exception("API Error"),
        {"content": [{"text": "{}"}]}
    ]

    service = AIAnalysisService(config)
    service.client = mock_client

    result = await service.analyze_drawing(image_data, [])

    assert mock_client.messages.create.call_count == 3
```

**TypeScript (Vitest)**:
```typescript
// tests/PDFViewer.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { PDFViewer } from '../components/PDFViewer';

describe('PDFViewer', () => {
  it('should render PDF and zoom controls', () => {
    render(<PDFViewer pdfUrl="test.pdf" />);

    expect(screen.getByText('+')).toBeInTheDocument();
    expect(screen.getByText('-')).toBeInTheDocument();
  });

  it('should zoom in when + button clicked', () => {
    const { getByText } = render(<PDFViewer pdfUrl="test.pdf" />);

    const zoomInButton = getByText('+');
    fireEvent.click(zoomInButton);

    // scale ãŒå¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  });
});
```

### 8.2 çµ±åˆãƒ†ã‚¹ãƒˆ

```python
# tests/integration/test_drawing_flow.py
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_complete_drawing_workflow(client: AsyncClient):
    # 1. å›³é¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    with open('test_data/sample_drawing.pdf', 'rb') as f:
        response = await client.post(
            '/api/drawings/upload',
            files={'file': f},
            data={'user_id': 'test_user'}
        )

    assert response.status_code == 200
    drawing_id = response.json()['drawing_id']

    # 2. è§£æçµæœã®å–å¾—
    response = await client.get(f'/api/drawings/{drawing_id}')
    drawing = response.json()
    assert drawing['status'] == 'analyzing' or drawing['status'] == 'pending'

    # 3. å›³é¢ç·¨é›†
    response = await client.put(
        f'/api/drawings/{drawing_id}',
        json={
            'extracted_fields': {'å›³ç•ª': 'TEST-001'},
            'user_id': 'test_user'
        }
    )
    assert response.status_code == 200

    # 4. æ‰¿èª
    response = await client.put(
        f'/api/drawings/{drawing_id}/approve',
        json={'user_id': 'test_user'}
    )
    assert response.status_code == 200
    assert response.json()['status'] == 'approved'
```

### 8.3 E2Eãƒ†ã‚¹ãƒˆ (Playwright)

```typescript
// tests/e2e/drawing-workflow.spec.ts
import { test, expect } from '@playwright/test';

test('complete drawing workflow', async ({ page }) => {
  // 1. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’é–‹ã
  await page.goto('http://localhost:3000');

  // 2. PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  await page.setInputFiles('input[type="file"]', 'test_data/sample.pdf');
  await page.click('button:has-text("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")');

  // 3. ç·¨é›†ç”»é¢ã«é·ç§»
  await expect(page.locator('.edit-form')).toBeVisible();

  // 4. å›³ç•ªã‚’ç·¨é›†
  await page.fill('input[name="å›³ç•ª"]', 'TEST-001');

  // 5. æ‰¿èªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
  await page.click('button:has-text("æ‰¿èª")');

  // 6. ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’ç¢ºèª
  await expect(page.locator('.toast')).toContainText('æ‰¿èªã—ã¾ã—ãŸ');
});
```

## 9. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 9.1 æƒ³å®šã•ã‚Œã‚‹è² è·

- åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼: 5-10äºº
- 1æ—¥ã‚ãŸã‚Šã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å›³é¢æ•°: 50-100æš
- 1å›³é¢ã‚ãŸã‚Šã®è§£ææ™‚é–“: 10-30ç§’ï¼ˆClaude APIä¾å­˜ï¼‰
- æ¤œç´¢å¿œç­”æ™‚é–“: <2ç§’

### 9.2 æœ€é©åŒ–æ–¹é‡

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

1. **éåŒæœŸå‡¦ç†**
   - FastAPI ã® async/await ã‚’æ´»ç”¨
   - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã§é‡ã„å‡¦ç†ã‚’å®Ÿè¡Œ

```python
from fastapi import BackgroundTasks

@app.post("/api/drawings/upload")
async def upload_drawing(
    file: UploadFile,
    background_tasks: BackgroundTasks
):
    # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã¯åŒæœŸçš„ã«å®Ÿè¡Œ
    drawing = await drawing_service.save_file(file)

    # AIè§£æã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
    background_tasks.add_task(
        drawing_service.analyze_in_background,
        drawing.id
    )

    return {"drawing_id": drawing.id, "status": "analyzing"}
```

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–**
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é©åˆ‡ãªé…ç½®
   - N+1å•é¡Œã®å›é¿ï¼ˆeager loadingï¼‰

```python
# N+1ã‚’é¿ã‘ã‚‹
from sqlalchemy.orm import joinedload

drawings = await session.execute(
    select(Drawing)
    .options(
        joinedload(Drawing.extracted_fields),
        joinedload(Drawing.balloons),
        joinedload(Drawing.tags)
    )
)
```

3. **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**
   - è§£ææ¸ˆã¿å›³é¢ã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_drawing_cache(drawing_id: str):
    return db.get_drawing(drawing_id)
```

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

1. **ã‚³ãƒ¼ãƒ‰åˆ†å‰²**
   - React.lazy() ã§ãƒ«ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®åˆ†å‰²

```typescript
const UploadView = lazy(() => import('./views/UploadView'));
const DrawingEditorView = lazy(() => import('./views/DrawingEditorView'));
```

2. **ä»®æƒ³åŒ–**
   - å¤§é‡ã®å›³é¢ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹éš›ã€react-window ã‚’ä½¿ç”¨

```typescript
import { FixedSizeList } from 'react-window';

const DrawingList = ({ drawings }) => (
  <FixedSizeList
    height={600}
    itemCount={drawings.length}
    itemSize={100}
  >
    {({ index, style }) => (
      <div style={style}>
        <DrawingCard drawing={drawings[index]} />
      </div>
    )}
  </FixedSizeList>
);
```

3. **ç”»åƒæœ€é©åŒ–**
   - ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆ200x300pxï¼‰
   - PDF.jsã®Workerã‚’ä½¿ç”¨ã—ã¦ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„

## 10. ãƒ­ã‚®ãƒ³ã‚°æˆ¦ç•¥

### 10.1 ãƒ­ã‚°å‡ºåŠ›è¨­è¨ˆ

**ãƒ­ã‚°ã®ç¨®é¡**:
1. **æ“ä½œãƒ­ã‚°**: èª°ãŒãƒ»ã„ã¤ãƒ»ä½•ã‚’ã—ãŸã‹
2. **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**: ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã€API ã‚¨ãƒ©ãƒ¼
3. **ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°**: APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´

**ãƒ­ã‚°ä¿å­˜å…ˆ**:
```
storage/
â””â”€â”€ logs/
    â”œâ”€â”€ operation.log      # æ“ä½œãƒ­ã‚°ï¼ˆå›³é¢ç™»éŒ²ã€ç·¨é›†ã€æ‰¿èªãªã©ï¼‰
    â”œâ”€â”€ error.log          # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
    â””â”€â”€ access.log         # APIã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
```

**Python ãƒ­ã‚®ãƒ³ã‚°è¨­å®š**:
```python
import logging
from logging.handlers import RotatingFileHandler

def setup_logging():
    # æ“ä½œãƒ­ã‚°
    operation_logger = logging.getLogger('operation')
    operation_logger.setLevel(logging.INFO)
    operation_handler = RotatingFileHandler(
        'storage/logs/operation.log',
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5
    )
    operation_handler.setFormatter(logging.Formatter(
        '%(asctime)s - %(levelname)s - %(message)s'
    ))
    operation_logger.addHandler(operation_handler)

    # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
    error_logger = logging.getLogger('error')
    error_logger.setLevel(logging.ERROR)
    error_handler = RotatingFileHandler(
        'storage/logs/error.log',
        maxBytes=10*1024*1024,
        backupCount=5
    )
    error_handler.setFormatter(logging.Formatter(
        '%(asctime)s - %(levelname)s - %(name)s - %(message)s'
    ))
    error_logger.addHandler(error_handler)

# ä½¿ç”¨ä¾‹
operation_logger = logging.getLogger('operation')
operation_logger.info(f"User {user_id} uploaded drawing {drawing_id}")
operation_logger.info(f"User {user_id} approved drawing {drawing_id}")
operation_logger.info(f"User {user_id} deleted {len(drawing_ids)} drawings")

error_logger = logging.getLogger('error')
error_logger.error(f"Claude API failed for drawing {drawing_id}: {str(e)}")
```

**FastAPI ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°**:
```python
from fastapi import Request
import time

@app.middleware("http")
async def log_requests(request: Request, call_next):
    start_time = time.time()

    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
    response = await call_next(request)

    # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²
    process_time = time.time() - start_time
    access_logger.info(
        f"{request.client.host} - {request.method} {request.url.path} "
        f"- {response.status_code} - {process_time:.2f}s"
    )

    return response
```

## 11. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### 11.1 ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ§‹æˆ

**èµ·å‹•æ–¹æ³•**: `python backend/main.py` ã¨ `npm run dev`ï¼ˆexeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ä¸è¦ï¼‰

```
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ :
cad-drawing-manager/
â”œâ”€â”€ backend/                # Python FastAPI
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ api/           # API routers
â”‚   â”‚   â”œâ”€â”€ services/      # Business logic
â”‚   â”‚   â”œâ”€â”€ models/        # SQLAlchemy models
â”‚   â”‚   â”œâ”€â”€ schemas/       # Pydantic schemas
â”‚   â”‚   â””â”€â”€ utils/         # PromptManager ãªã©
â”‚   â”œâ”€â”€ prompts/           # Claude prompt templates (.txt)
â”‚   â”‚   â”œâ”€â”€ extraction.txt
â”‚   â”‚   â”œâ”€â”€ classification.txt
â”‚   â”‚   â”œâ”€â”€ balloon_extraction.txt
â”‚   â”‚   â”œâ”€â”€ similarity_search.txt
â”‚   â”‚   â””â”€â”€ natural_language_query.txt
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ pyproject.toml
â”‚   â””â”€â”€ poetry.lock
â”œâ”€â”€ frontend/              # React + TypeScript
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ stores/        # Zustand stores
â”‚   â”‚   â”œâ”€â”€ api/           # API client
â”‚   â”‚   â””â”€â”€ main.tsx
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ vite.config.ts
â”œâ”€â”€ storage/               # ãƒ‡ãƒ¼ã‚¿ä¿å­˜å…ˆ
â”‚   â”œâ”€â”€ drawings/
â”‚   â”œâ”€â”€ thumbnails/
â”‚   â”œâ”€â”€ logs/              # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”‚   â”œâ”€â”€ operation.log
â”‚   â”‚   â”œâ”€â”€ error.log
â”‚   â”‚   â””â”€â”€ access.log
â”‚   â””â”€â”€ database.db
â”œâ”€â”€ config.json            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ .env                   # ç’°å¢ƒå¤‰æ•°
â””â”€â”€ README.md
```

### 11.2 èµ·å‹•æ‰‹é †

```bash
# 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
cd backend
poetry install

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
cd frontend
npm install

# 2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆï¼‰
cat > .env << EOF
AWS_REGION=us-west-2
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
DATABASE_URL=sqlite:///./storage/database.db
EOF

# 3. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p storage/drawings storage/thumbnails storage/logs

# 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•
cd backend
poetry run python -m app.main
# ã¾ãŸã¯
poetry run uvicorn app.main:app --reload --port 8000

# 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
cd frontend
npm run dev  # http://localhost:5173
```

**vite.config.ts** (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®ãƒ—ãƒ­ã‚­ã‚·è¨­å®š)
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      },
      '/ws': {
        target: 'ws://localhost:8000',
        ws: true
      }
    }
  }
});
```

### 11.3 è¨­å®šç®¡ç†

**config.json** (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†)
```json
{
  "extractionFields": [
    {"name": "å›³ç•ª", "required": true},
    {"name": "å›³é¢ã‚¿ã‚¤ãƒˆãƒ«", "required": true},
    {"name": "ä½œæˆæ—¥", "required": true},
    {"name": "æ‰¿èªè€…", "required": true},
    {"name": "ä¼šç¤¾å", "required": false},
    {"name": "å°ºåº¦", "required": false},
    {"name": "ææ–™", "required": false},
    {"name": "æè³ª", "required": false}
  ],
  "storagePath": "./storage/drawings/",
  "lockTimeout": 300,
  "retryAttempts": 3,
  "confidenceThreshold": 70
}
```

**.env** (AWSèªè¨¼æƒ…å ±)
```
AWS_REGION=us-west-2
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
DATABASE_URL=sqlite:///./storage/database.db
```

## 11. å®Ÿè£…ä¸Šã®æ³¨æ„äº‹é …

### 11.1 Claude APIä½¿ç”¨æ™‚ã®æ³¨æ„

1. **ç”»åƒã‚µã‚¤ã‚ºåˆ¶é™**
   - Claude APIã®ç”»åƒã‚µã‚¤ã‚ºä¸Šé™: 5MB
   - é€ä¿¡å‰ã«åœ§ç¸®ãƒ»ãƒªã‚µã‚¤ã‚ºå‡¦ç†ã‚’å®Ÿæ–½

2. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ**
   - **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯`.txt`ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†**
   - å›³æ æŠ½å‡ºã€é¢¨èˆ¹æŠ½å‡ºã€åˆ†é¡ã§åˆ¥ã€…ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
   - Few-shot examplesã‚’å«ã‚ã¦ç²¾åº¦å‘ä¸Š

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
backend/
â””â”€â”€ prompts/
    â”œâ”€â”€ extraction.txt       # å›³æ æƒ…å ±æŠ½å‡ºç”¨
    â”œâ”€â”€ classification.txt   # å›³é¢åˆ†é¡ç”¨
    â”œâ”€â”€ balloon_extraction.txt  # é¢¨èˆ¹æŠ½å‡ºç”¨
    â”œâ”€â”€ similarity_search.txt   # é¡ä¼¼æ¤œç´¢ç”¨
    â””â”€â”€ natural_language_query.txt  # è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒªè§£æç”¨
```

**extraction.txt ã®ä¾‹**:
```
ã‚ãªãŸã¯CADå›³é¢ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®å›³é¢ç”»åƒã‹ã‚‰ã€å›³æ å†…ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

æŠ½å‡ºã™ã‚‹é …ç›®:
{extraction_fields}

å‡ºåŠ›å½¢å¼ã¯ä»¥ä¸‹ã®JSONå½¢å¼ã«ã—ã¦ãã ã•ã„:
{{
  "extracted_fields": [
    {{
      "field_name": "å›³ç•ª",
      "value": "ABC-001",
      "confidence": 95,
      "coordinates": {{"x": 100, "y": 50, "width": 80, "height": 20}}
    }}
  ]
}}

ä¿¡é ¼åº¦(confidence)ã¯0-100ã®æ•´æ•°ã§ã€æŠ½å‡ºã—ãŸå€¤ã®ç¢ºå®Ÿæ€§ã‚’è¡¨ã—ã¦ãã ã•ã„ã€‚
åº§æ¨™(coordinates)ã¯ã€å›³é¢å†…ã§ã®è©²å½“ç®‡æ‰€ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
```

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚³ãƒ¼ãƒ‰**:
```python
class PromptManager:
    def __init__(self, prompts_dir: str = "prompts"):
        self.prompts_dir = Path(prompts_dir)

    def load_prompt(self, prompt_name: str) -> str:
        """
        ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿

        Args:
            prompt_name: "extraction", "classification" ãªã©

        Returns:
            ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—
        """
        prompt_path = self.prompts_dir / f"{prompt_name}.txt"
        if not prompt_path.exists():
            raise FileNotFoundError(f"Prompt file not found: {prompt_path}")

        with open(prompt_path, 'r', encoding='utf-8') as f:
            return f.read()

    def format_prompt(self, prompt_name: str, **kwargs) -> str:
        """
        ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå¤‰æ•°ç½®æ›ï¼‰

        Example:
            prompt = manager.format_prompt(
                "extraction",
                extraction_fields=["å›³ç•ª", "ã‚¿ã‚¤ãƒˆãƒ«"]
            )
        """
        template = self.load_prompt(prompt_name)
        return template.format(**kwargs)
```

3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ**
   - 429ã‚¨ãƒ©ãƒ¼æ™‚ã¯è‡ªå‹•çš„ã«ãƒªãƒˆãƒ©ã‚¤
   - æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã‚’ä½¿ç”¨

4. **ã‚³ã‚¹ãƒˆç®¡ç†**
   - è§£æçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦é‡è¤‡è§£æã‚’é˜²ã
   - APIã‚³ãƒ¼ãƒ«æ•°ã‚’ç›£è¦–

### 11.2 è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥**
```python
import socket
import os

def get_user_id() -> str:
    """
    PCã®ãƒ›ã‚¹ãƒˆåã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
    """
    hostname = socket.gethostname()
    username = os.getenv('USERNAME') or os.getenv('USER')
    return f"{username}@{hostname}"
```

2. **ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**
   - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã§å®šæœŸçš„ã«æœŸé™åˆ‡ã‚Œãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('interval', minutes=1)
async def cleanup_locks():
    await lock_manager.cleanup_expired_locks()

scheduler.start()
```

### 11.3 PDFå‡¦ç†

1. **è¤‡æ•°ãƒšãƒ¼ã‚¸PDFã®æ‰±ã„**
   - **å…¨ãƒšãƒ¼ã‚¸ã‚’å€‹åˆ¥ã®å›³é¢ã¨ã—ã¦æ‰±ã†**
   - å„ãƒšãƒ¼ã‚¸ã‚’åˆ¥ã€…ã«è§£æã—ã€ãã‚Œãã‚ŒDBç™»éŒ²
   - ãƒ•ã‚¡ã‚¤ãƒ«åã« `-page1`, `-page2` ãªã©ã‚’ä»˜ä¸

```python
import fitz  # PyMuPDF

def pdf_to_images(pdf_path: str) -> List[bytes]:
    """
    PDFã®å…¨ãƒšãƒ¼ã‚¸ã‚’ç”»åƒã«å¤‰æ›

    Returns:
        å„ãƒšãƒ¼ã‚¸ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ
    """
    doc = fitz.open(pdf_path)
    images = []

    for page_num in range(len(doc)):
        page = doc[page_num]
        # è§£åƒåº¦300dpiã§ç”»åƒåŒ–
        pix = page.get_pixmap(matrix=fitz.Matrix(300/72, 300/72))
        img_bytes = pix.tobytes("png")
        images.append(img_bytes)

    doc.close()
    return images

async def process_multipage_pdf(pdf_file: UploadFile, user_id: str) -> List[Drawing]:
    """
    è¤‡æ•°ãƒšãƒ¼ã‚¸PDFã‚’å‡¦ç†

    Returns:
        å„ãƒšãƒ¼ã‚¸ã”ã¨ã®Drawingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆ
    """
    # PDFã‚’ä¸€æ™‚ä¿å­˜
    temp_path = await save_temp_file(pdf_file)

    # å…¨ãƒšãƒ¼ã‚¸ã‚’ç”»åƒã«å¤‰æ›
    images = pdf_to_images(temp_path)

    drawings = []
    base_filename = pdf_file.filename.replace('.pdf', '')

    for page_num, image_data in enumerate(images, start=1):
        # å„ãƒšãƒ¼ã‚¸ã‚’å€‹åˆ¥ã®å›³é¢ã¨ã—ã¦ç™»éŒ²
        page_filename = f"{base_filename}-page{page_num}.pdf"

        # ãã®ãƒšãƒ¼ã‚¸ã ã‘ã®PDFã‚’æŠ½å‡º
        page_pdf = extract_single_page(temp_path, page_num - 1)

        # Drawingä½œæˆ
        drawing = await drawing_service.create_drawing_from_page(
            page_pdf,
            page_filename,
            image_data,
            user_id
        )

        drawings.append(drawing)

    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    os.remove(temp_path)

    return drawings
```

2. **ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ**
```python
from PIL import Image
from io import BytesIO

def generate_thumbnail(pdf_path: str, output_path: str):
    doc = fitz.open(pdf_path)
    page = doc[0]
    pix = page.get_pixmap(matrix=fitz.Matrix(0.5, 0.5))  # 50%ã‚µã‚¤ã‚º

    img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
    img.thumbnail((200, 300))
    img.save(output_path, "PNG")

    doc.close()
```

### 11.4 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çŠ¶æ…‹ç®¡ç†

```typescript
// stores/drawingStore.ts
import create from 'zustand';

interface DrawingStore {
  currentDrawing: Drawing | null;
  drawings: Drawing[];
  isLoading: boolean;

  setCurrentDrawing: (drawing: Drawing) => void;
  updateDrawing: (updates: Partial<Drawing>) => Promise<void>;
  approveDrawing: () => Promise<void>;

  // WebSocketã‹ã‚‰ã®æ›´æ–°ã‚’å—ä¿¡
  onDrawingLocked: (data: {drawing_id: string, user_id: string}) => void;
}

export const useDrawingStore = create<DrawingStore>((set, get) => ({
  currentDrawing: null,
  drawings: [],
  isLoading: false,

  setCurrentDrawing: (drawing) => set({ currentDrawing: drawing }),

  updateDrawing: async (updates) => {
    const { currentDrawing } = get();
    if (!currentDrawing) return;

    set({ isLoading: true });
    try {
      const updated = await api.updateDrawing(currentDrawing.id, updates);
      set({ currentDrawing: updated });
    } finally {
      set({ isLoading: false });
    }
  },

  onDrawingLocked: (data) => {
    const { currentDrawing } = get();
    if (currentDrawing?.id === data.drawing_id) {
      toast.error(`${data.user_id} ãŒç·¨é›†ä¸­ã§ã™`);
      // èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    }
  }
}));
```

---

**ä½œæˆæ—¥**: 2025-11-14
**ä½œæˆè€…**: Claude Code
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0ï¼ˆæœ€çµ‚ç‰ˆï¼‰

---

## ä»˜éŒ²Aï¼šè¿½åŠ è¦ä»¶ã®æ•´ç†

### å®Ÿè£…æ–¹é‡ã®ç¢ºå®šäº‹é …

1. **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: FastAPIï¼ˆDjangoä¸ä½¿ç”¨ï¼‰
   - ç†ç”±: éåŒæœŸå‡¦ç†ã«æœ€é©ã€è»½é‡ã€APIé–‹ç™ºã«ç‰¹åŒ–

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLite
   - ç†ç”±: ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã«æœ€é©ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç°¡å˜ã€æƒ³å®šè¦æ¨¡ã§ååˆ†

3. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†**: `.txt`ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
   - å ´æ‰€: `backend/prompts/`
   - PromptManager ã‚¯ãƒ©ã‚¹ã§èª­ã¿è¾¼ã¿ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

4. **è¤‡æ•°ãƒšãƒ¼ã‚¸PDF**: å…¨ãƒšãƒ¼ã‚¸ã‚’å€‹åˆ¥å›³é¢ã¨ã—ã¦æ‰±ã†
   - ãƒ•ã‚¡ã‚¤ãƒ«å: `{å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å}-page1.pdf`, `-page2.pdf` ãªã©

5. **ãƒ­ã‚®ãƒ³ã‚°**:
   - æ“ä½œãƒ­ã‚°: `storage/logs/operation.log`
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°: `storage/logs/error.log`
   - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°: `storage/logs/access.log`

6. **èµ·å‹•æ–¹æ³•**: `python backend/main.py` + `npm run dev`
   - exeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ä¸è¦

7. **ä¸è¦ãªæ©Ÿèƒ½**:
   - è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»å‰Šé™¤æ©Ÿèƒ½
   - è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
   - APIã‚³ã‚¹ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
   - ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½

### AWS Bedrockè¨­å®š

- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: `us-west-2` (ã‚ªãƒ¬ã‚´ãƒ³)
- **ãƒ¢ãƒ‡ãƒ«ID**: `anthropic.claude-sonnet-4-20250514`
- **èªè¨¼**: `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†

### å›³é¢ä»•æ§˜

- **ã‚µã‚¤ã‚º**: A3, A4 ãŒå¤šã„
- **å›³æ ä½ç½®**: å³ä¸‹
- **é¢¨èˆ¹è¡¨è¨˜**: ã€‡ã®ä¸­ã«æ–‡å­—ï¼ˆå›³ç•ªãªã©ï¼‰
- **æ”¹è¨‚å±¥æ­´**: è¡¨å½¢å¼ã®å ´åˆã¨éè¡¨å½¢å¼ã®å ´åˆã‚ã‚Šï¼ˆæŸ”è»Ÿã«å¯¾å¿œï¼‰

### åˆ†é¡åˆ¤å®šåŸºæº–

| åˆ†é¡ | åˆ¤å®šåŸºæº– |
|------|---------|
| **éƒ¨å“å›³** | é¢¨èˆ¹ãªã— + ææ–™æƒ…å ±ã‚ã‚Šï¼ˆãŒå¤šã„ï¼‰ |
| **ãƒ¦ãƒ‹ãƒƒãƒˆå›³** | é¢¨èˆ¹ã‚ã‚Š/ãªã— + è¤‡æ•°éƒ¨å“ã®çµ„ã¿åˆã‚ã› |
| **çµ„å›³** | é¢¨èˆ¹ã‚ã‚Š + è¨­å‚™å…¨ä½“ |

**æ³¨æ„**: ãƒ¦ãƒ‹ãƒƒãƒˆå›³ã¨çµ„å›³ã®æ˜ç¢ºãªåŒºåˆ¥ã¯å›°é›£ã€‚AIã«åˆ¤å®šã•ã›ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•èª¿æ•´ã€‚

### ã‚¿ã‚°é‹ç”¨

- **éšå±¤æ§‹é€ **: ä¸è¦ï¼ˆãƒ•ãƒ©ãƒƒãƒˆãªã‚¿ã‚°ï¼‰
- **äº‹å‰å®šç¾©ã‚¿ã‚°**: ãªã—ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰

### æ¤œç´¢ä»•æ§˜

- **è‡ªç„¶è¨€èªæ¤œç´¢**: Claude APIã§ã‚¯ã‚¨ãƒªè§£æ
  - ä¾‹: ã€Œ2024å¹´ä»¥é™ã®éƒ¨å“å›³ã€ã€Œæè³ªãŒSUS304ã§æ‰¿èªè€…ãŒå±±ç”°ã€
- **AND/ORæ¡ä»¶**: å¯¾å¿œ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥

- **æ–¹æ³•**: `socket.gethostname()` ã§PCãƒ›ã‚¹ãƒˆåå–å¾—
- **è¡¨ç¤º**: ãƒ›ã‚¹ãƒˆåã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°ä¸è¦ï¼‰

### ã‚¨ãƒ©ãƒ¼å‡¦ç†

- **è§£æå¤±æ•—æ™‚**: ã€Œè§£æå¤±æ•—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ä¸€è¦§ã«è¡¨ç¤ºã€ã€Œå†è§£æã€ãƒœã‚¿ãƒ³æä¾›
- **ä½ä¿¡é ¼åº¦è­¦å‘Š**: å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰50%ä»¥ä¸‹ã®å ´åˆã€è­¦å‘Šè¡¨ç¤º

### UI/UXè¨­å®š

- **å›³é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: ç”»é¢ã«åã¾ã‚‹ã‚µã‚¤ã‚ºï¼ˆFit to widthï¼‰
- **ä¸€è¦§ç”»é¢ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚½ãƒ¼ãƒˆ**: æ–°ã—ã„é †ï¼ˆupload_date DESCï¼‰

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- **æœ€å¤§åŒæ™‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ•°**: æœªå®šï¼ˆæŸ”è»Ÿã«å¯¾å¿œã€10-50æšã‚’æƒ³å®šï¼‰
- **å¹³å‡PDFã‚µã‚¤ã‚º**: æœªå®šï¼ˆ50MBã¾ã§å¯¾å¿œï¼‰
