# 要件定義書: 摘要表詳細ページの機能拡張

## 1. 概要

### 1.1 背景
現在の摘要表詳細ページ（`/spec-sheets/{id}`）では「部品リスト」と「改定履歴」の2タブ構成となっているが、「部品リスト」には実際には図面（組図・ユニット図）と部品（部品・購入品）が混在している。ユーザーは図面の階層構造を視覚的に確認したいニーズがある。また、「部品」タイプの場合は紐づける図面がないため、代わりに外部Webリンク（メーカーサイト等）を設定できるようにしたい。

### 1.2 目的
- 図面（assembly/unit）だけを表示する「図面ツリー」タブを追加し、階層構造を視覚化する
- 「部品」タイプのアイテムに対してWebリンク（URL）を設定できる機能を追加する
- 既存の「部品リスト」タブの名称を「部品・図面一覧」に変更し、実態に合わせる

## 2. 機能要件

### 2.1 図面ツリータブの追加

#### FR-2.1.1 タブ構成の変更
- 現在: 「部品リスト」「改定履歴」の2タブ
- 変更後: 「部品・図面一覧」「図面ツリー」「改定履歴」の3タブ

#### FR-2.1.2 図面ツリータブの表示内容
- `part_type`が`assembly`または`unit`のアイテムのみを表示
- 階層構造をツリー形式で表示
  - ルート: `assembly`（組図）
  - 子: `unit`（ユニット図）
  - 親子関係は`parent_item_id`に基づく
- 各ノードに表示する情報:
  - 品名（part_name）
  - 図番（drawing_number）
  - 種別アイコン/ラベル（組図/ユニット）
  - 紐づけ状態（紐づけ済み/未紐づけ）

#### FR-2.1.3 図面ツリーでの紐づけ機能
- 各ノードから図面紐づけが可能
- 紐づけ済みの場合:
  - 図面確認ボタン（編集ページへ遷移）
  - 紐づけ解除ボタン
- 未紐づけの場合:
  - 図面選択ダイアログを開くボタン

### 2.2 Webリンク機能の追加

#### FR-2.2.1 対象
- `part_type`が`part`のアイテムのみ
- `purchased`（購入品）は除外（別途検討）

#### FR-2.2.2 データモデルの拡張
- `spec_sheet_items`テーブルに`web_link`カラムを追加
  - 型: String（URL形式）
  - NULL許容

#### FR-2.2.3 UIでの表示・編集
- 「部品・図面一覧」タブのDataGridに「リンク」列を追加
- `part`タイプの行のみ編集可能
- 編集方法:
  - インラインセルでURLを直接入力
  - または編集アイコンクリックでダイアログ表示
- 表示:
  - URLが設定されている場合: 外部リンクアイコン（クリックで新規タブで開く）
  - 未設定の場合: 編集アイコン

### 2.3 既存機能の調整

#### FR-2.3.1 タブ名称変更
- 「部品リスト」→「部品・図面一覧」

#### FR-2.3.2 「図面」列の条件分岐
- 現状: 全アイテムで図面紐づけボタンを表示
- 変更後:
  - `assembly`/`unit`: 図面紐づけボタン（現状維持）
  - `part`: Webリンク設定ボタン
  - `purchased`: 非表示（または将来拡張用にグレーアウト）

## 3. 非機能要件

### 3.1 パフォーマンス
- 図面ツリーの初期表示: 500ms以内
- ツリーノードの展開/折りたたみ: 100ms以内

### 3.2 ユーザビリティ
- ツリーはデフォルトで全展開状態
- 展開/折りたたみ状態はセッション中維持
- レスポンシブ対応（モバイルでは縦スクロール）

### 3.3 アクセシビリティ
- キーボードナビゲーション対応（矢印キーでツリー移動）
- スクリーンリーダー対応（aria属性）

## 4. データモデル

### 4.1 既存テーブル修正

#### spec_sheet_items
```sql
ALTER TABLE spec_sheet_items ADD COLUMN web_link VARCHAR(2048);
```

### 4.2 APIスキーマ拡張

#### SpecSheetItemBase（更新）
```python
class SpecSheetItemBase(BaseModel):
    # ... 既存フィールド ...
    web_link: Optional[str] = Field(None, description="外部Webリンク（部品タイプのみ）")
```

#### UpdateWebLinkRequest（新規）
```python
class UpdateWebLinkRequest(BaseModel):
    web_link: Optional[str] = Field(None, description="外部WebリンクURL")
```

## 5. API仕様

### 5.1 既存API修正

#### GET /api/v1/spec-sheets/{id}
- レスポンスの`items`に`web_link`フィールドを追加

### 5.2 新規API

#### PATCH /api/v1/spec-sheets/{spec_sheet_id}/items/{item_id}/web-link
- リクエスト: `{ "web_link": "https://example.com" }`
- レスポンス: 更新後のSpecSheetItemResponse
- バリデーション:
  - `part_type`が`part`の場合のみ更新可能
  - URL形式のバリデーション（http/https）

## 6. UI仕様

### 6.1 タブ構成

```
┌────────────────┬──────────────┬────────────┐
│ 部品・図面一覧 │  図面ツリー   │  改定履歴  │
└────────────────┴──────────────┴────────────┘
```

### 6.2 図面ツリータブのレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ [展開] [折りたたみ]                                          │
├─────────────────────────────────────────────────────────────┤
│ ▼ [組図] DUST_COLLECTOR_ASSY (ST28431)    [✓紐づけ済] [👁]  │
│   ├─ ▼ [ユニット] DUST_GUARD_COVER_ASSY   [未紐づけ] [🔗]  │
│   │    └─ ... (子ユニットがある場合)                        │
│   └─ ▼ [ユニット] FRAME_ASSY (ST28433)    [✓紐づけ済] [👁]  │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 部品・図面一覧タブの「リンク」列

```
| No. | 種別 | 品名 | 図番 | ... | 図面/リンク |
|-----|------|------|------|-----|-------------|
| 1   | 組図 | ASSY | ST1  | ... | [✓] [👁]    |  ← 図面紐づけ
| 2   | 部品 | BOLT | -    | ... | [🔗外部]    |  ← Webリンク
| 3   | 購入品| -   | -    | ... | -           |  ← 非表示
```

## 7. 画面遷移

- 図面ツリーの「図面確認」ボタン → `/edit/{drawing_id}`
- Webリンクアイコンクリック → 新規タブで外部URL

## 8. 制約・前提条件

### 8.1 前提条件
- `parent_item_id`が正しく設定されていること
- `part_type`が正しく分類されていること

### 8.2 制約
- 1つのspecSheetItemに対してwebリンクは1つのみ
- Webリンクはhttpまたはhttpsスキームのみ許可
- 循環参照（A→B→A）は発生しない前提

## 9. 今後の拡張候補（スコープ外）
- 購入品へのWebリンク機能
- 図面ツリーのドラッグ&ドロップによる親子関係変更
- ツリーからの部品一括選択・操作
- 図面プレビュー（ツリーノードホバー時）

---

**作成日**: 2025-12-15
**作成者**: Claude Code
**バージョン**: 2.0
