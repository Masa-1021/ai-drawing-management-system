# 要件定義書 - AI駆動型CAD図面管理システム

## 1. 目的

本システムは、AWS Claude Sonnet 4のAI能力を活用し、CAD図面（PDF形式）を自動解析・分類・管理するローカルWebアプリケーションです。主な目的は以下の通りです：

- CAD図面の図枠情報を自動抽出し、手作業による情報入力を削減
- 図面の種類（部品図/ユニット図/組図）を自動分類（ユーザーによる手動調整可能）
- 自然言語による直感的な図面検索を実現
- 視覚的な形状類似性による図面検索（プレート図など）
- 複数ユーザーでの同時使用（ログイン不要、編集ロック機能付き）
- 承認ワークフローによる図面データの品質保証
- ローカルストレージによる図面データの安全な管理

## 2. 機能要件

### 2.1 必須機能

#### 2.1.1 設定管理機能
- [ ] **図枠抽出フィールド設定**
  - 設定ファイル（JSON/YAML）による抽出項目の定義
  - システム起動前に設定ファイルを編集
  - 必須項目とオプション項目の指定
- [ ] **保存先設定**
  - 設定ファイルで図面保存先ディレクトリを指定
  - デフォルト：`./storage/drawings/`

#### 2.1.2 AWS Claude Sonnet 4連携機能
- [ ] AWS認証情報（UserID、Account ID）を使用したClaude Sonnet 4 APIの呼び出し
- [ ] 画像解析用のプロンプト最適化（図枠、風船、改訂履歴の読み取り）
- [ ] **APIエラーハンドリングとリトライ機構**
  - 自動リトライ：最大3回
  - リトライ間隔：指数バックオフ（2秒、4秒、8秒）
  - 失敗時は該当図面をスキップし、次の図面に進む
  - ユーザーに「再解析」ボタンを表示
- [ ] レート制限への対応
- [ ] **信頼度スコアの取得**
  - 各抽出フィールドの信頼度（0-100%）を取得
  - 70%未満のフィールドに警告表示

#### 2.1.3 図面アップロード機能
- [ ] 複数PDFファイルの同時アップロード対応（ドラッグ&ドロップ）
- [ ] アップロード進捗表示
- [ ] ファイルサイズ・形式のバリデーション
- [ ] PDF→画像変換機能（Claude APIへの送信用）
- [ ] 複数ページPDF対応

#### 2.1.4 AI解析機能
- [ ] **図枠情報の自動抽出**
  - 作成日（作図日）
  - 承認者（承認印、サイン）
  - 会社名
  - 図番（図面番号）
  - 図面タイトル
  - 尺度
  - 材料・材質情報
  - その他の図枠内テキスト情報
- [ ] **改訂履歴の抽出**
  - 改訂番号
  - 改訂日
  - 改訂内容
  - 改訂者
- [ ] **図面分類機能**
  - 部品図：単一部品の詳細図（風船なし）
  - ユニット図：複数部品を組み合わせた中間アセンブリ（風船あり）
  - 組図：設備全体の組立図（風船あり）
  - AI による初期分類提案（ユーザーが手動で調整可能）
  - 分類根拠の記録（材料情報、風船の有無など）
- [ ] **風船情報の抽出**（ユニット図・組図の場合）
  - 風船番号
  - 部品名称
  - 数量
  - 風船の座標位置（後のハイライト用）
- [ ] **図面内容の要約生成**
  - 自然言語による図面の説明文（類似検索用）
  - 形状特徴の抽出（プレート図の場合：サイズ、穴の数、パターンなど）

#### 2.1.5 解析結果表示・編集機能
- [ ] **2分割レイアウト（デスクトップ）**
  - 左側：解析結果一覧（編集可能フォーム）30%
  - 右側：PDF図面プレビュー 70%
  - 幅比率は固定（リサイズバー不要）
- [ ] **レスポンシブレイアウト（モバイル/タブレット）**
  - 縦並び表示（上：編集フォーム、下：PDF）
- [ ] **解析結果一覧の編集機能**
  - 全ての抽出フィールドの編集可能化
  - 各フィールドに信頼度を％表示（例：95%）
  - 信頼度70%未満のフィールドにインライン警告（フィールド下に黄色い警告テキスト）
  - タグの追加・削除
  - 分類カテゴリの変更（ドロップダウン）
  - 風船情報の追加・編集・削除（テーブル形式）
- [ ] **編集フォームのセクション構成**
  - 基本情報（図番、タイトル、作成日など）
  - タグ・分類
  - 改訂履歴（テーブル表示）
  - 風船情報（テーブル表示）
  - 編集履歴（タブまたは展開パネル）
- [ ] **インタラクティブハイライト機能**
  - 左側のラベル（項目）クリック時、右側の該当箇所を拡大表示
  - 該当箇所を枠線やハイライトで強調表示
  - 風船クリック時の該当風船へのズーム機能
- [ ] **PDFプレビュー機能**
  - 拡大・縮小
  - 回転
  - 複数ページPDFのページめくり
- [ ] **複数図面の順次処理**
  - 1枚ずつ順番に表示・編集
  - 進捗インジケーター（例：3/10枚目）
  - 前の図面に戻る機能
  - 「次へ」「スキップ」「承認」ボタン

#### 2.1.6 承認・保存機能
- [ ] 承認ボタンによるデータ確定
- [ ] **承認取り消し機能**
  - 承認済み図面を未承認状態に戻す
  - 承認済み一覧にステータス表示で残る（「承認」「未承認」ラベル）
  - 未承認状態から即座に再承認可能
- [ ] **編集ロック機能（複数ユーザー対応）**
  - ユーザー識別：PCのホスト名またはユーザー名
  - 先に編集を始めた人が図面をロック
  - 他のユーザーは読み取り専用で表示
  - ロック中の通知：トースト通知（右上）
  - ロック解除：編集画面を閉じる、または一定時間（5分）経過後
- [ ] **編集履歴の記録**
  - 誰が（PCのホスト名/ユーザー名）
  - いつ（タイムスタンプ）
  - 何を（変更したフィールドと変更前後の値）
  - 編集履歴は図面詳細画面のタブに表示
- [ ] ローカルストレージへのメタデータ保存
  - JSON形式での構造化データ保存
  - PDF原本ファイルの保存（ファイル名の自動リネーム）
  - タグ情報の保存
  - 風船情報の保存
  - 分類カテゴリの保存
  - 信頼度スコアの保存
  - 編集履歴の保存
- [ ] 保存済み図面の一覧表示

#### 2.1.7 自然言語検索機能（別タブ）
- [ ] **自然言語クエリの解析**
  - 「作成者が〇〇の図面を全部ほしい」
  - 「2024年1月以降の組図」
  - 「材質がSS400の部品図」
  - などの自然言語入力対応
- [ ] **検索結果の表示**
  - テーブル表示とカード表示の切り替え可能
  - テーブル：図番、図面タイトル、分類、作成日、承認者などの列表示
  - カード：サムネイル付きカード形式
  - ソート機能
  - フィルタ機能
- [ ] **選択的ダウンロード機能**
  - チェックボックスによる複数選択
  - 選択した図面のZIPダウンロード
  - 個別ダウンロード

#### 2.1.8 類似図面検索機能（別タブ）
- [ ] **検索トリガー**
  - 図面詳細画面に「類似図面を検索」ボタンを配置
  - ボタンクリックで類似検索タブに遷移し、結果を表示
- [ ] **視覚的形状類似性の検索**
  - プレート図の場合：形状、サイズ、穴の数、パターンの類似性
  - Claude APIによる画像比較またはベクトル埋め込みを使用
- [ ] **検索結果の表示**
  - 類似度スコア（%）を表示
  - 類似度の高い順にソート
  - テーブル/カード表示の切り替え可能
  - 検索元図面と並べて表示

#### 2.1.9 一括操作機能
- [ ] **図面の複数選択**
  - チェックボックスによる複数図面の選択
- [ ] **一括タグ付け**
  - 選択した複数図面に同じタグを一括追加
- [ ] **一括カテゴリ変更**
  - 選択した複数図面の分類を一括変更
- [ ] **一括ダウンロード**
  - 選択した複数図面をZIP形式でダウンロード
- [ ] **一括削除**
  - 承認済み図面も削除可能
  - モーダルダイアログで確認（「〇件の図面を削除しますか？」）

#### 2.1.10 UI/UX要件
- [ ] **デザインシステム**
  - メインカラー：白
  - アクセントカラー：青
  - シンプルで業務用に適したデザイン
  - ダークモード不要
- [ ] **ナビゲーション**
  - 上部ナビゲーションバー
  - メニュー項目：アップロード、検索、類似検索、一覧
- [ ] **初期画面**
  - アプリ起動時はアップロード画面を表示
- [ ] **通知・アラート**
  - 信頼度70%未満：インライン警告（黄色テキスト）
  - 同時編集ロック：トースト通知（右上）
  - 一括削除確認：モーダルダイアログ（画面中央）
  - 保存成功/失敗：トースト通知（右上）
- [ ] **ボタン配置**
  - 承認、キャンセルなど：画面右下または各セクション下部

### 2.2 オプション機能（将来実装）

- [ ] 図面バージョン管理（改訂履歴の自動追跡）
- [ ] 図面間の関連付け（部品図→ユニット図→組図の階層構造）
- [ ] OCR精度の学習・改善機能
- [ ] エクスポート機能（Excel、CSV）
- [ ] 図面の比較機能（差分表示）
- [ ] 承認ワークフローの複数段階化
- [ ] 統計・レポート機能（ダッシュボード）
- [ ] バックアップ・エクスポート/インポート機能

## 3. 非機能要件

### 3.1 パフォーマンス

- **応答時間**
  - 図面アップロード後、10秒以内にAI解析を開始
  - 1枚あたりの解析時間：30秒以内（Claude API依存）
  - 検索結果表示：2秒以内
- **同時処理**
  - 複数図面のバックグラウンド解析対応
  - 最大10枚まで同時キューイング
- **ストレージ**
  - 1,000枚以上の図面管理に対応
  - PDFファイルサイズ：1枚あたり最大50MB

### 3.2 セキュリティ

- **AWS認証情報の保護**
  - 環境変数またはAWS認証情報ファイルの使用
  - ハードコード禁止
- **ローカルデータの保護**
  - 図面データはローカルPCのみに保存
  - 外部への送信はClaude APIのみ（解析時）
- **入力検証**
  - PDFファイルの形式検証
  - SQLインジェクション対策（検索クエリ）
  - XSS対策

### 3.3 保守性

- **コード品質**
  - TypeScript使用による型安全性確保
  - コンポーネントの再利用性
  - テストコードの整備（カバレッジ70%以上）
- **ログ機能**
  - エラーログの記録
  - API呼び出しログ
  - ユーザー操作ログ

### 3.4 互換性

- **ブラウザ対応**
  - Chrome 最新版
  - Edge 最新版
  - Firefox 最新版
- **OS対応**
  - Windows 10/11
  - macOS (オプション)
  - Linux (オプション)
- **PDF対応**
  - PDF 1.4以降

## 4. 制約事項

### 4.1 技術的制約

- **AWS Claude Sonnet 4の制限**
  - API呼び出しレート制限に依存
  - 画像解析の精度はモデルに依存
  - コスト：従量課金制
- **PDF処理**
  - ラスター画像化が必要（ベクターデータの直接解析不可）
- **ローカル実行**
  - Node.js実行環境が必要
  - ローカルストレージの容量制限
- **OCR精度**
  - 手書き文字の認識精度は低い可能性
  - 図面の品質（解像度、汚れ）に依存

### 4.2 ビジネス制約

- **初期開発期間**
  - MVP：2-3週間
- **運用コスト**
  - AWS Claude API使用料（従量課金）
- **ユーザー**
  - 複数ユーザーでの同時使用（ログイン不要）
  - 全員が同じ図面プールを共有
  - 編集時は排他制御（ロック機能）

## 5. 成功基準

### 5.1 完了の定義

- [ ] PDF図面をアップロードし、図枠情報を90%以上の精度で抽出できる
- [ ] 各抽出フィールドの信頼度が表示される
- [ ] 図面分類（部品図/ユニット図/組図）を85%以上の精度で自動判定できる
- [ ] 風船情報を80%以上の精度で抽出できる
- [ ] 解析失敗時に最大3回自動リトライし、失敗した図面をスキップできる
- [ ] 解析結果の編集・承認フローが正常に動作する
- [ ] 複数ユーザーが同時にアクセスし、編集ロック機能が正常に動作する
- [ ] 編集履歴が正しく記録・表示される
- [ ] 自然言語検索で適切な図面を検索できる
- [ ] 類似図面検索（形状ベース）で関連図面を検索できる
- [ ] 複数図面の一括処理が可能
- [ ] インタラクティブハイライトが正常に動作する
- [ ] 承認済み図面のダウンロードが可能
- [ ] 一括操作（タグ付け、削除、ダウンロード）が正常に動作する
- [ ] 承認の取り消しと再承認が正常に動作する

### 5.2 受け入れテスト

- **テストケース1**：10枚の異なる種類の図面をアップロードし、全て正しく分類される
- **テストケース2**：信頼度70%未満のフィールドに警告が表示され、手動編集できる
- **テストケース3**：「作成者が田中の図面」と検索し、該当する図面のみが表示される
- **テストケース4**：プレート図を選択し「類似検索」を実行、類似する図面が表示される
- **テストケース5**：解析結果の編集後、正しく保存され、編集履歴が記録される
- **テストケース6**：風船情報をクリックし、該当箇所が正しくハイライトされる
- **テストケース7**：2人のユーザーが同じ図面を編集しようとし、ロック通知が表示される
- **テストケース8**：複数図面を選択し、一括タグ付け・ダウンロードができる
- **テストケース9**：承認済み図面を未承認に戻し、再度承認できる
- **テストケース10**：API解析失敗時に自動リトライし、3回失敗後はスキップされる

## 6. 想定されるリスク

### 6.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Claude APIの解析精度が低い | 高 | プロンプトエンジニアリングの最適化、信頼度表示、手動編集機能の充実 |
| APIコストが予想以上に高い | 中 | 使用量監視、キャッシュ機能の実装 |
| PDF解像度が低く文字認識失敗 | 中 | 前処理での画像補正、手動編集機能の充実、信頼度による警告 |
| ローカルストレージの容量不足 | 低 | 容量警告機能、古いデータのアーカイブ機能 |
| 風船位置の特定が困難 | 中 | バウンディングボックス情報の取得、手動位置調整機能 |
| 複数ユーザーの同時編集による競合 | 中 | 編集ロック機能、リアルタイム通知 |
| 類似検索の精度が低い | 中 | プロンプト最適化、複数の類似度指標の組み合わせ |

### 6.2 ビジネスリスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| ユーザーの期待精度に届かない | 高 | 編集機能の充実、段階的リリース |
| 図面フォーマットの多様性 | 中 | 複数フォーマットでのテスト、学習機能の実装 |

## 7. 今後の検討事項

### 7.1 設計フェーズで詳細化すべき事項

- **設定ファイルの仕様**
  - 図枠抽出フィールド定義のスキーマ（JSON/YAML）
  - 保存先ディレクトリの設定方法
- **データベーススキーマ設計**
  - 図面メタデータの構造
  - 風船情報のリレーション
  - タグ管理の方式
  - 編集履歴テーブル
  - ロック情報テーブル
  - 信頼度スコアの保存方法
- **フロントエンド技術選定**
  - React / Vue.js / Svelte
  - UIコンポーネントライブラリ（青/白カラースキーム対応）
  - PDF表示ライブラリ（PDF.js など）
  - トースト通知ライブラリ
  - モーダルダイアログコンポーネント
- **バックエンド技術選定**
  - Node.js + Express / Fastify
  - Python + FastAPI（オプション）
  - WebSocket（リアルタイム編集ロック通知用）
- **ローカルストレージ設計**
  - SQLite / NeDB / LokiJS
  - ファイルシステム構造（PDF保存、サムネイル生成）
  - ロック管理の実装方式（ファイルロック/DBレコード）
- **Claude API連携詳細**
  - プロンプトテンプレート（図枠抽出、風船抽出、分類、類似検索）
  - 画像前処理の仕様（解像度、フォーマット）
  - レスポンスパースロジック（信頼度スコアの取得方法）
  - リトライロジックの詳細（指数バックオフ）
- **自然言語検索の実装方式**
  - Claude APIを使った検索クエリ解析
  - ベクトル検索（Embedding）の活用
- **類似検索の実装方式**
  - 視覚的類似性の判定方法（画像比較/ベクトル埋め込み）
  - プレート図の特徴抽出方法
- **ハイライト機能の実装方式**
  - 座標情報の取得・保存方法
  - PDFビューアへの描画方法
- **画面レイアウト設計**
  - 各画面のワイヤーフレーム
  - 上部ナビゲーションバーの構成
  - レスポンシブデザインのブレークポイント

### 7.2 追加調査が必要な事項

- CAD図面の標準的な図枠フォーマット（JIS規格など）
- 業界固有の風船記法
- Claude Sonnet 4のVision機能の詳細仕様と制限
- PDFからの座標情報抽出方法
- 複数ページPDFの取り扱い（全ページ解析 vs 最初のページのみ）
- ユーザー識別方法の詳細（PCホスト名取得方法）
- 編集ロックのタイムアウト実装方法

---

**作成日**: 2025-11-14
**作成者**: Claude Code
**バージョン**: 2.0（最終版）

---

## 付録A：画面構成概要

### メイン画面構成

```
┌─────────────────────────────────────────────────────────┐
│ ヘッダー（上部ナビゲーション）                            │
│ [ロゴ] [アップロード] [検索] [類似検索] [一覧]          │
├─────────────────────────────────────────────────────────┤
│                                                           │
│                  メインコンテンツエリア                    │
│                  （各画面がここに表示）                    │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### 図面編集画面（2分割）

```
┌───────────────────┬─────────────────────────────┐
│ 左：編集フォーム   │ 右：PDFプレビュー             │
│ （30%）           │ （70%）                     │
│                   │                             │
│ 📄 基本情報       │ [PDF表示エリア]              │
│ 図番: [...] 95%   │                             │
│ タイトル: [...] 88%│ [拡大/縮小/回転ツール]       │
│                   │                             │
│ 🏷️ タグ・分類     │                             │
│ ...               │                             │
│                   │                             │
│ 📝 改訂履歴       │                             │
│ [テーブル]         │                             │
│                   │                             │
│ 🎈 風船情報       │                             │
│ [テーブル]         │                             │
│                   │                             │
│ 📜 編集履歴       │                             │
│ [展開パネル]       │                             │
│                   │                             │
│ [承認] [キャンセル]│                             │
└───────────────────┴─────────────────────────────┘
```

### 検索画面（タブ切り替え）

```
┌─────────────────────────────────────────────────┐
│ [自然言語検索]  [類似検索]                       │
├─────────────────────────────────────────────────┤
│                                                 │
│ 検索内容エリア                                   │
│                                                 │
├─────────────────────────────────────────────────┤
│ [テーブル表示] [カード表示]                      │
│                                                 │
│ 検索結果エリア                                   │
│                                                 │
└─────────────────────────────────────────────────┘
```

## 付録B：設定ファイル例

### config.json（例）

```json
{
  "extractionFields": [
    {"name": "図番", "required": true},
    {"name": "図面タイトル", "required": true},
    {"name": "作成日", "required": true},
    {"name": "承認者", "required": true},
    {"name": "会社名", "required": false},
    {"name": "尺度", "required": false},
    {"name": "材料", "required": false},
    {"name": "材質", "required": false}
  ],
  "storagePath": "./storage/drawings/",
  "lockTimeout": 300,
  "retryAttempts": 3,
  "confidenceThreshold": 70
}
```
